<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SBOM - Software Bill of Materials</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }

      h1 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .subtitle {
        color: #7f8c8d;
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .search-box {
        flex: 1;
        min-width: 250px;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .search-box:focus {
        outline: none;
        border-color: #3498db;
      }

      .filter-select {
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        background: white;
        cursor: pointer;
        min-width: 200px;
      }

      .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        min-width: 150px;
        text-align: center;
      }

      .stat-card.secondary {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .stat-card.tertiary {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }

      .repo-section {
        margin-bottom: 40px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
      }

      .repo-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.3s;
      }

      .repo-header:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      }

      .repo-header.collapsed {
        background: #95a5a6;
      }

      .repo-name {
        font-size: 1.5em;
        font-weight: bold;
      }

      .repo-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
      }

      .repo-content {
        padding: 20px;
        display: none;
      }

      .repo-content.expanded {
        display: block;
      }

      .packages-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .packages-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #ddd;
        position: sticky;
        top: 0;
      }

      .packages-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      .packages-table tr:hover {
        background: #f8f9fa;
      }

      .package-name {
        font-weight: 600;
        color: #2c3e50;
      }

      .package-version {
        color: #7f8c8d;
        font-size: 0.9em;
      }

      .license-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        margin-right: 5px;
        background: #e8f4f8;
        color: #2c3e50;
      }

      .risk-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
      }

      .risk-critical {
        background: #fee;
        color: #c33;
      }

      .risk-high {
        background: #ffe6e6;
        color: #d44;
      }

      .risk-medium {
        background: #fff3cd;
        color: #856404;
      }

      .risk-low {
        background: #d4edda;
        color: #155724;
      }

      .risk-varies {
        background: #e7f3ff;
        color: #004085;
      }

      .language-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        background: #f0f0f0;
        color: #555;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
      }

      .error {
        background: #fee;
        color: #c33;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      .no-results {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
        font-size: 1.1em;
      }

      .toggle-icon {
        transition: transform 0.3s;
      }

      .toggle-icon.collapsed {
        transform: rotate(-90deg);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Software Bill of Materials (SBOM)</h1>
      <p class="subtitle">
        Complete inventory of all packages and dependencies across our
        repositories
      </p>

      <div class="controls">
        <input
          type="text"
          id="searchBox"
          class="search-box"
          placeholder="Search packages, licenses, or languages..."
        />
        <select id="repoFilter" class="filter-select">
          <option value="">All Repositories</option>
        </select>
        <select id="riskFilter" class="filter-select">
          <option value="">All Risk Levels</option>
          <option value="critical">Critical</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
          <option value="varies_on_usage">Varies on Usage</option>
        </select>
      </div>

      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-value" id="totalPackages">-</div>
          <div class="stat-label">Total Packages</div>
        </div>
        <div class="stat-card secondary">
          <div class="stat-value" id="totalRepos">-</div>
          <div class="stat-label">Repositories</div>
        </div>
        <div class="stat-card tertiary">
          <div class="stat-value" id="uniqueLicenses">-</div>
          <div class="stat-label">Unique Licenses</div>
        </div>
      </div>

      <div id="content">
        <div class="loading">Loading SBOM data...</div>
      </div>
    </div>

    <script>
      let allData = [];
      let filteredData = [];

      // CSV parsing function - handles quoted fields with commas
      function parseCSV(text) {
        const lines = text.split("\n").filter((line) => line.trim());
        if (lines.length === 0) return [];

        // Parse header
        const headers = parseCSVLine(lines[0]);
        const data = [];

        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;

          const values = parseCSVLine(lines[i]);
          if (values.length !== headers.length) continue;

          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index] || "";
          });

          // Only add rows with a repository
          if (row.repo && row.repo.trim()) {
            data.push(row);
          }
        }

        return data;
      }

      // Parse a single CSV line, handling quoted fields
      function parseCSVLine(line) {
        const fields = [];
        let currentField = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          const nextChar = line[i + 1];

          if (char === '"') {
            if (inQuotes && nextChar === '"') {
              // Escaped quote
              currentField += '"';
              i++; // Skip next quote
            } else {
              // Toggle quote state
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            // Field separator
            fields.push(currentField.trim());
            currentField = "";
          } else {
            currentField += char;
          }
        }

        // Add last field
        fields.push(currentField.trim());

        return fields;
      }

      // Group data by repository
      function groupByRepo(data) {
        const grouped = {};
        data.forEach((item) => {
          const repo = item.repo.trim();
          if (!grouped[repo]) {
            grouped[repo] = [];
          }
          grouped[repo].push(item);
        });
        return grouped;
      }

      // Render the page
      function render(data) {
        const contentDiv = document.getElementById("content");

        if (data.length === 0) {
          contentDiv.innerHTML =
            '<div class="no-results">No packages found matching your search criteria.</div>';
          return;
        }

        const grouped = groupByRepo(data);
        const repos = Object.keys(grouped).sort();

        let html = "";
        repos.forEach((repo) => {
          const packages = grouped[repo];
          html += `
                    <div class="repo-section">
                        <div class="repo-header" onclick="toggleRepo('${repo}')">
                            <div>
                                <span class="repo-name">${escapeHtml(
                                  repo
                                )}</span>
                                <span class="repo-count">${
                                  packages.length
                                } package${
            packages.length !== 1 ? "s" : ""
          }</span>
                            </div>
                            <span class="toggle-icon" id="icon-${repo}">â–¼</span>
                        </div>
                        <div class="repo-content" id="content-${repo}">
                            <table class="packages-table">
                                <thead>
                                    <tr>
                                        <th>Package Name</th>
                                        <th>Version</th>
                                        <th>License</th>
                                        <th>Language</th>
                                        <th>Risk</th>
                                        <th>Organization</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${packages
                                      .map(
                                        (pkg) => `
                                        <tr>
                                            <td class="package-name">${escapeHtml(
                                              pkg.package_name || "N/A"
                                            )}</td>
                                            <td class="package-version">${escapeHtml(
                                              pkg.package_version || "N/A"
                                            )}</td>
                                            <td>${formatLicenses(
                                              pkg.license_type
                                            )}</td>
                                            <td><span class="language-badge">${escapeHtml(
                                              pkg.language || "N/A"
                                            )}</span></td>
                                            <td>${formatRisk(pkg.risk)}</td>
                                            <td>${escapeHtml(
                                              pkg.org_name || "N/A"
                                            )}</td>
                                        </tr>
                                    `
                                      )
                                      .join("")}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
        });

        contentDiv.innerHTML = html;

        // Expand first repo by default
        if (repos.length > 0) {
          toggleRepo(repos[0]);
        }
      }

      // Format licenses
      function formatLicenses(licenseStr) {
        if (!licenseStr || licenseStr.trim() === "")
          return '<span class="license-badge">Unknown</span>';
        const licenses = licenseStr.split(",").map((l) => l.trim());
        return licenses
          .map(
            (license) =>
              `<span class="license-badge">${escapeHtml(license)}</span>`
          )
          .join("");
      }

      // Format risk
      function formatRisk(risk) {
        if (!risk || risk.trim() === "")
          return '<span class="risk-badge">-</span>';
        const riskClass = risk.toLowerCase().replace(/\s+/g, "-");
        return `<span class="risk-badge risk-${riskClass}">${escapeHtml(
          risk
        )}</span>`;
      }

      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Toggle repository section
      function toggleRepo(repo) {
        const content = document.getElementById(`content-${repo}`);
        const icon = document.getElementById(`icon-${repo}`);
        const header = icon.parentElement;

        if (content.classList.contains("expanded")) {
          content.classList.remove("expanded");
          icon.classList.add("collapsed");
          header.classList.add("collapsed");
        } else {
          content.classList.add("expanded");
          icon.classList.remove("collapsed");
          header.classList.remove("collapsed");
        }
      }

      // Filter data
      function filterData() {
        const searchTerm = document
          .getElementById("searchBox")
          .value.toLowerCase();
        const repoFilter = document.getElementById("repoFilter").value;
        const riskFilter = document.getElementById("riskFilter").value;

        filteredData = allData.filter((item) => {
          const matchesSearch =
            !searchTerm ||
            (item.package_name &&
              item.package_name.toLowerCase().includes(searchTerm)) ||
            (item.license_type &&
              item.license_type.toLowerCase().includes(searchTerm)) ||
            (item.language &&
              item.language.toLowerCase().includes(searchTerm)) ||
            (item.org_name && item.org_name.toLowerCase().includes(searchTerm));

          const matchesRepo = !repoFilter || item.repo === repoFilter;
          const matchesRisk =
            !riskFilter ||
            (item.risk &&
              item.risk.toLowerCase().replace(/\s+/g, "_") === riskFilter);

          return matchesSearch && matchesRepo && matchesRisk;
        });

        render(filteredData);
        updateStats(filteredData);
      }

      // Update statistics
      function updateStats(data) {
        const grouped = groupByRepo(data);
        const uniqueLicenses = new Set();
        data.forEach((item) => {
          if (item.license_type) {
            item.license_type.split(",").forEach((license) => {
              uniqueLicenses.add(license.trim());
            });
          }
        });

        document.getElementById("totalPackages").textContent =
          data.length.toLocaleString();
        document.getElementById("totalRepos").textContent =
          Object.keys(grouped).length;
        document.getElementById("uniqueLicenses").textContent =
          uniqueLicenses.size;
      }

      // Populate repository filter
      function populateRepoFilter() {
        const repos = [
          ...new Set(allData.map((item) => item.repo).filter((r) => r)),
        ].sort();
        const select = document.getElementById("repoFilter");
        repos.forEach((repo) => {
          const option = document.createElement("option");
          option.value = repo;
          option.textContent = repo;
          select.appendChild(option);
        });
      }

      // Load CSV file
      fetch("license_report.csv")
        .then((response) => {
          if (!response.ok) {
            throw new Error(
              `Failed to load CSV file: ${response.status} ${response.statusText}`
            );
          }
          return response.text();
        })
        .then((text) => {
          allData = parseCSV(text);
          filteredData = allData;
          populateRepoFilter();
          render(filteredData);
          updateStats(filteredData);
        })
        .catch((error) => {
          const isLocalFile = window.location.protocol === "file:";
          let errorMessage = `Error loading SBOM data: ${error.message}`;

          if (isLocalFile) {
            errorMessage += `<br><br><strong>Note:</strong> This page must be served via a web server (not opened directly as a file). 
            On GitHub Pages, the CSV will load automatically. For local testing, run a simple server:<br>
            <code>python3 -m http.server 8000</code> then visit <code>http://localhost:8000</code>`;
          }

          document.getElementById(
            "content"
          ).innerHTML = `<div class="error">${errorMessage}</div>`;
        });

      // Event listeners
      document
        .getElementById("searchBox")
        .addEventListener("input", filterData);
      document
        .getElementById("repoFilter")
        .addEventListener("change", filterData);
      document
        .getElementById("riskFilter")
        .addEventListener("change", filterData);
    </script>
  </body>
</html>
